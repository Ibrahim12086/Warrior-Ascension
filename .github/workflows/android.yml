name: Warrior Ascension Quick Build

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. تنظيف وتجهيز المجلدات الأساسية فقط
      - name: Prepare Folders
        run: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/cpp
          mkdir -p android/app/src/main/res/mipmap-hdpi
          
          # نقل الملفات الموجودة فعلياً
          [ -d "Content" ] && cp -r Content/* android/app/src/main/assets/ || echo "No Content folder"
          [ -d "Source" ] && cp -r Source/* android/app/src/main/cpp/ || echo "No Source folder"
          [ -d "GameEngine" ] && cp -r GameEngine/* android/app/src/main/cpp/ || echo "No GameEngine folder"
          
          # البحث عن أي صورة png لتكون أيقونة
          find . -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-hdpi/ic_launcher.png || echo "No Icon found"

      # 2. إنشاء ملفات Gradle بسيطة جداً (بدون أخطاء DependencyHandler)
      - name: Create Simple Gradle
        run: |
          echo "include ':app'" > android/settings.gradle
          
          cat <<GRADLE_ROOT > android/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:7.4.2' }
          }
          allprojects {
              repositories { google(); mavenCentral() }
          }
          GRADLE_ROOT

          cat <<GRADLE_APP > android/app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.ibrahim.warrior'
              compileSdk 33
              defaultConfig {
                  applicationId "com.ibrahim.warrior"
                  minSdk 24
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
                  externalNativeBuild { cmake { cppFlags "-std=c++17" } }
              }
              externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt" } }
          }
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
          }
          GRADLE_APP

      # 3. إنشاء ملف الربط (CMake)
      - name: Create CMake
        run: |
          cat <<CMAKE > android/app/src/main/cpp/CMakeLists.txt
          cmake_minimum_required(VERSION 3.10.2)
          project("warrior_game")
          file(GLOB_RECURSE SRC_FILES *.cpp *.c)
          if(SRC_FILES)
              add_library(warrior_lib SHARED ${SRC_FILES})
              find_library(log-lib log)
              target_link_libraries(warrior_lib ${log-lib} android EGL GLESv2 OpenSLES)
          endif()
          CMAKE

      # 4. إنشاء المانيفست الأساسي
      - name: Create Manifest
        run: |
          cat <<MANIFEST > android/app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.ibrahim.warrior">
              <application android:label="Warrior Ascension" android:icon="@mipmap/ic_launcher">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          MANIFEST
          # إنشاء كود تشغيل فارغ لمنع الـ Crash
          mkdir -p android/app/src/main/java/com/ibrahim/warrior
          echo "package com.ibrahim.warrior; import android.app.Activity; public class MainActivity extends Activity {}" > android/app/src/main/java/com/ibrahim/warrior/MainActivity.java

      # 5. البناء النهائي
      - name: Build APK
        working-directory: ./android
        run: |
          gradle wrapper --gradle-version 7.5
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Ascension-Fix
          path: "android/app/build/outputs/apk/debug/*.apk"
