name: Reconstruct and Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Nuking Old Configs & Generating Fresh Build System
        run: |
          # مسح كل إعدادات جرادل القديمة لأنها السبب
          rm -rf android/build.gradle android/settings.gradle android/gradle
          rm -rf android/app/build.gradle
          
          # إنشاء مجلدات ضرورية
          mkdir -p android/app/src/main
          
          # 1. إنشاء ملف settings.gradle سليم
          echo "rootProject.name = 'WarriorAscension'" > android/settings.gradle
          echo "include ':app'" >> android/settings.gradle
          
          # 2. إنشاء ملف build.gradle الرئيسي
          cat <<EOG > android/build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.1.1'
              }
          }
          EOG
          
          # 3. إنشاء ملف build.gradle للتطبيق (بدون تعقيدات)
          cat <<EOG > android/app/build.gradle
          plugins {
              id 'com.android.application'
          }
          
          android {
              namespace 'com.warrior.ascension'
              compileSdk 34
              
              defaultConfig {
                  applicationId "com.warrior.ascension"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
                  
                  ndk {
                      abiFilters 'armeabi-v7a', 'arm64-v8a'
                  }
                  
                  externalNativeBuild {
                      cmake {
                          cppFlags "-std=c++17"
                      }
                  }
              }
              
              externalNativeBuild {
                  cmake {
                      path "src/main/cpp/CMakeLists.txt"
                      version "3.22.1"
                  }
              }
          }
          
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
          }
          EOG
          
          # 4. البناء باستخدام Gradle المثبت في النظام
          cd android
          gradle assembleDebug --stacktrace --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Fresh-Build
          path: android/app/build/outputs/apk/debug/app-debug.apk
