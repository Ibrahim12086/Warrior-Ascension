name: Warrior Ascension Final Recovery

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. إنشاء هيكل مشروع أندرويد جديد تماماً لو الملفات ناقصة
      - name: Initialize Android Project
        run: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/cpp
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          # إنشاء ملف settings.gradle لتعريف المشروع
          echo "include ':app'" > android/settings.gradle
          
          # إنشاء ملف build.gradle الرئيسي (الخارجي)
          cat <<GRADLE_ROOT > android/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:7.4.2' }
          }
          allprojects {
              repositories { google(); mavenCentral() }
          }
          GRADLE_ROOT

      # 2. نقل ملفات اللعبة (Assets & C++)
      - name: Inject Game Files
        run: |
          cp -r Content/* android/app/src/main/assets/ || true
          cp -r Source/* android/app/src/main/cpp/ || true
          cp -r GameEngine/* android/app/src/main/cpp/ || true
          # إعداد الأيقونة
          find Content/Icons -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true

      # 3. كتابة ملف build.gradle الخاص بالتطبيق (الداخلي)
      - name: Create App Config
        run: |
          cat <<GRADLE_APP > android/app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.ibrahim.warriorascension'
              compileSdk 33
              defaultConfig {
                  applicationId "com.ibrahim.warriorascension"
                  minSdk 24
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
                  externalNativeBuild { cmake { cppFlags "-std=c++17" } }
              }
              externalNativeBuild {
                  cmake { path "src/main/cpp/CMakeLists.txt"; version "3.22.1" }
              }
              aaptOptions { noCompress "mp3", "wav", "ogg", "pak", "bin", "data" }
          }
          GRADLE_APP

      # 4. إنشاء ملف CMakeLists.txt لربط الـ C++
      - name: Create CMake Linker
        run: |
          echo "cmake_minimum_required(VERSION 3.18.1)" > android/app/src/main/cpp/CMakeLists.txt
          echo "project(\"warrior_game\")" >> android/app/src/main/cpp/CMakeLists.txt
          echo "add_library(warrior_lib SHARED)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "file(GLOB_RECURSE SRC_FILES *.cpp *.c)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "target_sources(warrior_lib PRIVATE ${SRC_FILES})" >> android/app/src/main/cpp/CMakeLists.txt
          echo "find_library(log-lib log)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "target_link_libraries(warrior_lib ${log-lib} android EGL GLESv2 OpenSLES)" >> android/app/src/main/cpp/CMakeLists.txt

      # 5. توليد ملف gradlew وبناء اللعبة
      - name: Build With Auto-Generated Wrapper
        working-directory: ./android
        run: |
          gradle wrapper --gradle-version 7.5
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload Final APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Ascension-Final
          path: "android/app/build/outputs/apk/debug/*.apk"
