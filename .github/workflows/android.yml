name: Warrior Ascension Final Stable Build

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # بناء بيئة العمل من غير مسح ملفاتك الأصلية
      - name: Prepare Android Environment
        run: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/cpp
          mkdir -p android/app/src/main/java/com/ibrahim/warrior
          mkdir -p android/app/src/main/res/mipmap-hdpi

          # نقل ملفاتك (البرمجة والمحتوى)
          cp -r Content/* android/app/src/main/assets/ || true
          cp -r Source/* android/app/src/main/cpp/ || true
          cp -r GameEngine/* android/app/src/main/cpp/ || true
          
          # الأيقونة
          find . -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-hdpi/ic_launcher.png || true

      # إنشاء ملف البداية (ده اللي هيمنع الـ Crash اللي في الصورة)
      - name: Create Entry Point
        run: |
          cat <<JAVA > android/app/src/main/java/com/ibrahim/warrior/MainActivity.java
          package com.ibrahim.warrior;
          import android.app.Activity;
          import android.os.Bundle;
          public class MainActivity extends Activity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  // هنا المحرك بيبدأ يشتغل
              }
          }
          JAVA

      - name: Configure Build System
        run: |
          echo "include ':app'" > android/settings.gradle
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:8.1.0' } }" > android/build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> android/build.gradle
          
          cat <<APP_GRADLE > android/app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.ibrahim.warrior'
              compileSdk 33
              defaultConfig {
                  applicationId "com.ibrahim.warrior"
                  minSdk 24
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
              }
          }
          APP_GRADLE

      - name: Build APK
        working-directory: ./android
        run: |
          gradle wrapper --gradle-version 8.0
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Ascension-Final
          path: "android/app/build/outputs/apk/debug/*.apk"
