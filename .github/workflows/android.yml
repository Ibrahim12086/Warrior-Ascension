name: Warrior Ascension Auto-Repair & Build

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle 7.5
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      # 1. تجهيز ونقل الملفات الضخمة (Assets & Source)
      - name: Move Assets and Source
        run: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/cpp
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          # نقل المحتوى
          echo "Moving Game Assets..."
          cp -r Content/* android/app/src/main/assets/ || true
          
          # نقل الكود للترجمة
          echo "Moving Source Code..."
          cp -r Source/* android/app/src/main/cpp/ || true
          cp -r GameEngine/* android/app/src/main/cpp/ || true

          # إعداد الأيقونة
          find Content/Icons -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true

      # 2. إنشاء ملف CMakeLists.txt جديد وسليم
      - name: Generate CMakeLists.txt
        run: |
          echo "cmake_minimum_required(VERSION 3.10.2)" > android/app/src/main/cpp/CMakeLists.txt
          echo "project(\"warrior_game\")" >> android/app/src/main/cpp/CMakeLists.txt
          echo "file(GLOB_RECURSE SRC_FILES *.cpp *.c)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "add_library(warrior_lib SHARED ${SRC_FILES})" >> android/app/src/main/cpp/CMakeLists.txt
          echo "find_library(log-lib log)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "target_link_libraries(warrior_lib ${log-lib} android EGL GLESv2 OpenSLES)" >> android/app/src/main/cpp/CMakeLists.txt

      # 3. الخطوة السحرية: إصلاح ملف build.gradle باستخدام بايثون (لتجنب الأخطاء)
      - name: Python Fixer for Gradle
        run: |
          cat <<PYTHON_SCRIPT > fixer.py
          import os

          gradle_path = "android/app/build.gradle"
          
          # كود الربط الذي نريد إضافته
          cmake_block = """
              externalNativeBuild {
                  cmake {
                      path "src/main/cpp/CMakeLists.txt"
                  }
              }
          """

          with open(gradle_path, "r") as f:
              content = f.read()

          # التحقق مما إذا كان الكود موجوداً مسبقاً
          if "externalNativeBuild" not in content:
              # البحث عن نهاية كتلة android { وإضافة الكود قبلها
              # نبحث عن آخر قوس إغلاق للكائن android
              # هذه طريقة بسيطة: البحث عن 'defaultConfig' وإضافتها بعدها لضمان المكان الصحيح
              if "defaultConfig {" in content:
                  new_content = content.replace("defaultConfig {", "defaultConfig {" + cmake_block)
                  with open(gradle_path, "w") as f:
                      f.write(new_content)
                  print("Success: Injecting CMake block into build.gradle")
              else:
                  print("Warning: Could not find good place to inject CMake block")
          else:
              print("Info: CMake block already exists")
          
          # إصلاح المانيفست للأيقونة
          manifest_path = "android/app/src/main/AndroidManifest.xml"
          try:
              with open(manifest_path, "r") as f:
                  m_content = f.read()
              m_content = m_content.replace('android:icon="@mipmap/ic_launcher"', 'android:icon="@mipmap/ic_launcher"') # تأكيد
              if 'android:icon' in m_content and '@mipmap/ic_launcher' not in m_content:
                   # استبدال أي أيقونة موجودة بأيقونتنا
                   import re
                   m_content = re.sub(r'android:icon="[^"]*"', 'android:icon="@mipmap/ic_launcher"', m_content)
              
              with open(manifest_path, "w") as f:
                  f.write(m_content)
              print("Success: Manifest updated")
          except:
              print("Warning: Manifest not found")

          PYTHON_SCRIPT
          
          # تشغيل السكربت
          python3 fixer.py

      # 4. البناء النهائي
      - name: Build Fixed Project
        working-directory: ./android
        run: |
          gradle wrapper --gradle-version 7.5
          ./gradlew assembleDebug --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Repaired-Game
          path: "android/app/build/outputs/apk/debug/*.apk"
