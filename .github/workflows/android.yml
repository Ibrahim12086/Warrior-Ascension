name: Warrior Ascension Nuclear Fix

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. تثبيت NDK ضروري جداً لملفات الـ C++
      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      - name: Install NDK
        run: sdkmanager "ndk;25.1.8937393" "cmake;3.22.1"

      # 2. نقل الـ 500 ميجا (Assets + Source)
      - name: Move Game Assets & Source
        run: |
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/cpp
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          echo "Moving Assets (This may take time)..."
          cp -r Content/* android/app/src/main/assets/ || true
          
          echo "Moving Source Code..."
          cp -r Source/* android/app/src/main/cpp/ || true
          cp -r GameEngine/* android/app/src/main/cpp/ || true

          # إعداد الأيقونة
          find Content/Icons -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true

      # 3. إنشاء ملف CMakeLists.txt (الرابط بين اللعبة والمحرك)
      - name: Generate CMakeLists.txt
        run: |
          echo "cmake_minimum_required(VERSION 3.18.1)" > android/app/src/main/cpp/CMakeLists.txt
          echo "project(\"warrior_game\")" >> android/app/src/main/cpp/CMakeLists.txt
          echo "add_library(warrior_lib SHARED)" >> android/app/src/main/cpp/CMakeLists.txt
          # إضافة كل ملفات cpp تلقائياً
          echo "file(GLOB_RECURSE SRC_FILES *.cpp *.c)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "target_sources(warrior_lib PRIVATE ${SRC_FILES})" >> android/app/src/main/cpp/CMakeLists.txt
          echo "find_library(log-lib log)" >> android/app/src/main/cpp/CMakeLists.txt
          echo "target_link_libraries(warrior_lib ${log-lib} android EGL GLESv2 OpenSLES)" >> android/app/src/main/cpp/CMakeLists.txt

      # 4. (الخطوة الحاسمة) كتابة ملف build.gradle جديد تماماً
      # هذا يحل مشكلة الأقواس المكسورة والخطأ السابق
      - name: Overwrite build.gradle
        run: |
          cat <<GRADLE_FILE > android/app/build.gradle
          plugins {
              id 'com.android.application'
          }

          android {
              namespace 'com.ibrahim.warriorascension'
              compileSdk 33
              ndkVersion "25.1.8937393"

              defaultConfig {
                  applicationId "com.ibrahim.warriorascension"
                  minSdk 24
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
                  
                  // هذا السطر يربط الكود بملفات الـ C++
                  externalNativeBuild {
                      cmake {
                          cppFlags "-std=c++17"
                      }
                  }
              }

              // إعدادات للتعامل مع الملفات الكبيرة (500 ميجا)
              aaptOptions {
                  noCompress "mp3", "wav", "ogg", "pak", "bin", "data"
              }

              buildTypes {
                  debug {
                      minifyEnabled false
                  }
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              // رابط ملف الـ CMake الذي أنشأناه
              externalNativeBuild {
                  cmake {
                      path "src/main/cpp/CMakeLists.txt"
                      version "3.22.1"
                  }
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.9.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          GRADLE_FILE

      # 5. إصلاح المانيفست
      - name: Fix Manifest
        run: |
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/' android/app/src/main/AndroidManifest.xml || true
          # إضافة صلاحية قراءة الملفات
          sed -i '/<application/i <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"\/>' android/app/src/main/AndroidManifest.xml || true

      # 6. البناء
      - name: Build New Project
        working-directory: ./android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Reborn-Game
          path: "android/app/build/outputs/apk/debug/*.apk"
