name: Warrior Ascension Mega Builder

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle 7.5
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      # خطوة "الجمع القسري" - تجميع الـ 500 ميجا في مكان واحد
      - name: Universal Asset Collector
        run: |
          # 1. تجهيز المسارات وتوسيع سعة الاستيعاب
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android/app/src/main/cpp

          # 2. نقل كل شيء بلا استثناء (Content, Source, GameEngine)
          echo "Moving 500MB of data..."
          cp -rv Content/* android/app/src/main/assets/ || true
          cp -rv Source/* android/app/src/main/cpp/ || true
          cp -rv GameEngine/* android/app/src/main/cpp/ || true

          # 3. تثبيت الأيقونة (إجبارياً)
          # يبحث عن أكبر ملف صورة في مجلد Icons ويجعله الأيقونة
          find Content/Icons -name "*.png" | head -n 1 | xargs -I {} cp {} android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true
          
          # 4. إصلاح ملف الـ Manifest برمجياً لربط الأيقونة والتصاريح
          # هذا يحل مشكلة الأيقونة الظاهرة في الصورة [1000159788.jpg]
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/' $MANIFEST || true
          # إضافة تصريح قراءة الملفات الكبيرة
          sed -i '/<application/i <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"\/>' $MANIFEST || true

      # 5. تعديل إعدادات Gradle لعدم ضغط الملفات (لتسريع التشغيل ومنع الـ Crash)
      - name: Configure Large Assets
        run: |
          echo "android { aaptOptions { noCompress '' } }" >> android/app/build.gradle || true

      - name: Final Mega Build
        working-directory: ./android
        run: |
          gradle wrapper --gradle-version 7.5
          ./gradlew assembleDebug --stacktrace

      - name: Upload Mega APK
        uses: actions/upload-artifact@v4
        with:
          name: Warrior-Full-Project-Fixed
          path: "android/app/build/outputs/apk/debug/*.apk"
